//
//  Day20.swift
//  AdventOfCode2021
//
//  Created by Justin Roughley on 18/12/2021.
//

func day20() {
  
  let algorithmTest =
  "..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#"
  
  let algorithm =
  "#.#..#..####....##.##..#.#.###..###..######.#..#####.#..###..#.####.#..###.##..#.......##....###...#####....#.##..#.#.#...###..#.####.##.#.###...#.###.##.#..#.#..#....#.#.#...#...#.#....###.#.#.#....###.##..#.##...##.#..##...##########.####....#..##..###.#..###..#.#...########.#.##.##...##....#.#..####.###....#.....#.##.#.##.......#....###......###..#.###.#...######..###..#..#.....##.###..##.###....##..#..#..##..##.#.###.#.#.#...#.#####.....#.##.....#..####.###.#.#.######.###.....##.#...#.###..#####...##..."
    .map{ $0 == "#" ? 1 : 0 }

  let imageTest =
  """
  #..#.
  #....
  ##..#
  ..#..
  ..###
  """

  let image =
"""
#.#....###...###.#.######.#..#.####.#..#..#####.#..###.#..##..####....#####..#.#......##..#.##...#..
.#.........#..##.####.##...####.###.##.##.#.##..##........##.##.#....###..###.#.##...#.#.#.##...#.#.
.###...#...#.#...#.##......#..#.#.#####..........#..#.##.#..#.#.##.###.##..........####.#.#.###...#.
##.#.#.#.######.##..####.####.##.#..##..#####..##.#..######.#..##..####.####.##.##....#.#.#.........
####.#.#.######....##.##..#..#...#.##.##.##..#..#.##.##.....##.#....####.###...#...##.##.#..#.#.####
..##..##...#..##.#.##....##..#####.#.#....#.##.###....#.##.##..####..#.#.###.#.#.....##.##.##.......
...#...#.######.#..##.##...#....##.##.###....###.#..#.#.#..##...#.#...#.#.#.....#..##....#..#.##...#
.....#....##..#.##.#.###....#.#..###.#..##..####..#..###..##.#.#.#..###..#.#.#.#..#.###.#.#..##..#..
###...##.##....#..##..##.#.#.##.#...####.##.#.#.#.#.#.#.#.#.#...##.#####.#...###.#..#..#########.#.#
####..##....##.#..#..#.##.####.##...#...##..#####...#.#.#.#..####.#..#..##.....##..##...##.##..###.#
..#.#...####....####.#..#.##...#..##.#####....###.#.##.####.####.######.#.####.###..##.##...#.#.#..#
.#.#.#..###############...##.###########...#.#..#..##.#...##..#.#.#####.###.##..###..#####...#.#.#..
...##...##.######.#..##..#..####......#.###..####.###..##..#.#.#..##...##.#.##.##.#..##.#.##..##..#.
#####..##.##.######...#.##..#....###.###..#.#.###..#.####.###.#...#.#.....##############.#.##.......
.##.#..####..##.#####.#.#...#.....##..#.###.....#..##.##..#.#...##..##...#.#.##...##.......##..#.#.#
#####.##.##...#..#..#.#.##.#...#...#.##.....#.###.#...#..##.##.#...####...#..##..##...#...###.##..#.
#.#####..###..######..##...#..###.#####..#.##.#.#.##..##.#.##..##..#...#.##.##.##.#.#.###..###....#.
#...#....##.###.#...##.#..#..#.#..#..####.#....#...#.##.....#.....#....##.###.##.#.####.#.#...##....
#.#....##..###.#..##....#.......#.#.#####....##..#.#..#..#..#..#..##.#..#.....##.##.#.####..#.##.##.
##...###.#...######..#.#.#.#.##.#.#####..#.#.##.##.#....#.#.###.#.#.#.#...###.....##.........#..#.##
...###..#.##.###..####.###...#.#.##..#.####....##..####.##...#..#.#.#..#..#.##..###.##.#.#...#...#.#
#.####.....#.#..##..###.#...###.##...##..#..##...#.#..###.##..#...##.#...#.#.#..###..##..###.#..#..#
..##.###.#####.####.#.#.....###........#..#.##########..#....#..#....#.#.###.##...##..###..#.#.###..
#.#..#...#.#.#.###.#####..#...#.#....#.####..#..#...#..#...##.##.##.##..#########.#......###....#...
...##..#.#.###..##..##.###.##.#.#...#..##...####.....##..#.##.#.#..####..#..##.#..####.##.####.#..#.
##.#.##.###.#...#.##.#.#.#...##...####.#.....#..#.#.###.#.###....##.#.##...##.#.##..#........#....##
..###.#.#.#.....###.....##...##..#.###..#..##.#......####.####....#.###.#.#.....##..#.##..##....##.#
.#..####.###...####.#...##...#..###.##....#.######..#.###.#...#.#####.#.###..#.......#..#.###..#.#..
#...####..#...#..#...#.#...#.#.#.##.#..###..#..#.#.#.###.#.............##..#.###.#.#...#..#.#...#.#.
..##.###.#.#..###..##......###.#...#.###.########.#......##..##....#.###.##.#.....####.#.#........##
##..#.##.##.###..#.##.####.#..#####.......#..#.#####..##.#####.###....#..#.#..#..#...#.###.##.#..##.
.#..#...#..#.#..###.###.#.....##.###.#....#.##.#.##.#.#..#..##...#...#.###.#..#......###..#.#.##..#.
##..####.##.###.#..#..##..##.###.##.#.###.#...###.##....##.#..##.....#.#....##.#...##..........##.##
##.#...#.#..#.#.##.#.#.#..##.##...#..#####.#..#.#.#.#....#..#..#.######.#..#..#.#######.#....#.....#
.#.....#####.###.###...#.####..#####...##...#..#...#..##...#.##.#..#.#........#.#.#..#.#.#.###..##..
###...#.##..#......#.##.#..###.####.#..##.#..#..#..##..#...#.##.##......###.#.#.#.###........##.###.
.#...##.##..#.#.....##.####.........###.##..##.#......#...#.#..#..##.....#######.##.###...#....##.##
#....#.#...#..#.###..##.....##....####.#####.##.#..#.#...#......#...#....#.##.#.....#..#..#..####..#
###.##.####....#.#.....#..#...#.....###.########....##..##.........##..#..####.#..#..#.#.##...#.##..
.....##.#.####.####..#...##.##.#........####.###....#..####.#.##.#.#.#####..#....##..#......##.#..#.
###.#...###..#..#.###..##.##....###.#.....###.##...#.######.#..#......####.#.#..###.##.###....#...#.
##..#.......#...##.###..###.#####.##....#####.#####...##........####....#...##....#.###..##.#..##..#
..##.##.#.#.#.#.##...##.#.#.####..##...##..###.##.#####.#...#####..#.#.#..#.#.##.##.#....###..#...#.
.#..#.###..##..#.#.##.###...###.######.##....#.....##.#.###.....##.#####..##.####...#.##.#..##..#...
#...##....##.#.#####.####.###..#.....#..#.#.#.###..#####.##.....##.##....#.#.#.#.####..##.###..##...
###....#....#..###..#..#..##.#..###...##...##..###..#.#.##..#.##.#....#..#.##.##..####.#.#####...###
#.#..##...#.#.######..##...#.#.#..##.##.....##.#.#......#..####.....#.#....##.###..####.#..#####.#..
.###.##...##..###...#.#..###..##....###.###..##.#..#.####...#...#####.##.##.##....#....##..#.##...##
..#.#.###.....##...#..##.#...#####.##.###.##..####.###...#.#####.#....##...#...#..####...#..##..##.#
##.#..#..#..###..#.#..##...####.###..###.#....####...#.###.#..##..#..##.##.####.#...#.#.##...#.....#
.#...###.#....##.#..#.......#.#.###..###..##.###..#.#...##..#...#...##...#.#.###.##.#.#.##....#.##.#
.#####...#####...#...#.#.####.#.....####.......#.###.#..#...####.#.#..##...#....###.#.##..#..#..#.##
.#.###.#....#...###.#.#..#..####.#..#..#.#...###.###.####...#...#.#.#.#..##..#..#...##...##.....#..#
...##..#...#.##..#.##.####...####.#.###..###..#####.##..#.####.#.###.#.#.###..#...#..###.....#.##...
.########...##.##.##.....#...#####..####..###..#...#.####..#...###.#..###.#...#..#.#...#.#..#...#...
.##.#####.#..#...###...##.....##.#...####.###.##.#.#...#.#.#.#..#.#...##...#...#.##.####.####.####..
##.###.##..#####...#..####....#.###..####..#..#.#.###...##.##.##..###.#.#.##.#.#.#.##..#.#..#....#..
....##..##...###..#.#.....##...#####.#.#...####..##.######.#...#...#.###.##.#.#.#.###.#.###.#...####
#.####...##.#.#..##.#####.##..##.###...#..#......##...#.#.#.###...#.##...#..#...##.#..###.#...#...##
..#..##.#.##.#.#.##..#####.....#.#.###.#.#.#.###..#####.#.....#.##..####.##.#.#.#.##...###....#.#..#
#.#.#..#.##.#.#.##.#...#....#..##.#.##.#.#.#.####.###.###.#.#.####..#..####.#..#....##..####.....###
##...#..#.####....##..#####.###....#..####.#.####..#.#..#.##.##......#..#####...#.##..####....#.#.##
.#.....##....#...###.######.#..#.###...#.#.#..#...#..##...#####...##..#...#####.#.#.###.###..##....#
.###......###.#..#..#...#.##...#.#...#.#..#..##........#..#.####.#.#..##...##.#....###.##..###.#.#..
..###.....#.#....#..#######.####..###...#...#....#...#..##.#..#.##.##..#.##..###...###.##...##....##
#.##..#####..##.####.#.#.#....#.#.#.#..#.#...####.#..#.#.#.##.##.....#..##...#.##....#..#..#..#.#...
##.##.###.#...#.#.#...#...#..###.###.###...###.#...##....#.###.##........#..###..#.#..###..####.....
##.##.##.###..##...#.#.#.#...#...##.#.##..#.#.####..##..#####....#.#####..#####..#.######.#.#.##.##.
..#...##..##..##...#......#..#..#.#..##...#...#....#.#.#...#.#.#..##.#.#...#...#.#.###....###...#...
...####..#########...#.#.#.##.#.#.#.##.#.##...#.####.#.##.#.####.#......##.#.####.#.##.#..###.#.#..#
#.###.##.###.#.#..###...#.##.######.#.#..#.#####.#.###.#..##..#....###..#.#..#......##.#.###...#.###
##..#.#..###.#.#.#.##.##.##..##..#.#.....##.#.#...#.####.##..##.....##..#.####...###...#.###..##.##.
..#.#...#.#.#.##...#..#....######...#.#.##.###.#..####...#.##.#..#..###........#.....###.#..##..##..
..#.#..#.#....#.#..#....###..###.#...###..####...####.#.#.#..#.....#.###.#.#..#.######.###########..
..#...#..#..##.#.##.#.#.##......####.##.#.###.##..##.#.##.#..#.#.##.#...####.#.#.#..#####.#..######.
##.......#####.....#....#..##.#.##..#.###.#..#######.#.#.#....#.#...##.##..##..##..#....###.#....##.
##...##...##..##.#.#..###.###..###..#######.....####..#.##..######....#..#.#.#.#######..#.####.#####
...#.###..##....##.##..#..#...#####...#..##...#.###...###.##....##..#.##.####..##.#...#.##..##..#.#.
......##.###.#.##..#####.#.##.#.#..##.######.##.#..#.#...#....##.##...#.#####.###.####..#.#.###.#.##
#.#.#..#....#.#..#.#..#.####..#.#.###..###.######..#.####.###..##.#.##...###..##.#######.#..##.###..
#...#...######.#.##.......#..##.#..###..#####.#..##...##.#..#.###.###..##.#..#.###.#..#.#.#..#....##
#######..#.#.###..#...##..#...#..##...####..#.####...##.#..#....####.##.#.#..###.#.##.#..#..#.#.##..
.##.##.##.#..###..####.#..##.....#..###...#.#.###.##..###.#..#.###..###..#.####..#.#....#....####.#.
.#..##.#..##.#.#.##.#.###.#..#..###.#.#..#.#...#####...###.#....#..#.#.#..#.#.##.#..#...##.#.###.#..
#.###..####..###.#.#.##.#.#.#......####.#...#..##.#....#...#.######...#########.#...##.###.#..###.##
##.########....##...###..##.#.#..#.####..#..###.......##..#.####.###...#..###...###......####...#...
.#..########.#.##.#.####..#..##..###.#.##.#..##.##..##.#..##....#...#...###.#.#.#.###.#..#.##.#.###.
##....########..........#.#.###.###..##.##.#....#.#..####.######.#.##.#.#..###...#.##.#.#..##.....##
.####......###..#.##.#.#....##.#...#..##.##.#######.#..###...###..###...#.....###.#.##....##...#.#..
####....#.#..######..#.######..#####..#.##.##..##.#.#.#.....##.###..#.###.##.###.#......##.#..####.#
.#...###..#..#.###...##.#..####..#...#.###.#####..#..#.#..###.#####.##.#..##.#.#.##.....#...###....#
..###..##..#..##..####..##.#.#......#..##.#.##.#.####....##.##.###..##..##.#.##..#####.#.##....#.#.#
.##...##.#.#.###..#.##.#..##..#..#....###....#.##.#...##...#######.###..##...##.##.##.#######....###
##..#.#.###..###...###.##..#.##..#.#.#.###.##...###....#.#..#.#..##.#..##.##....#..#...#....###...#.
#.#..###.##.######.#.#####.#...##..##.....##...##...##..#.###.#...#.#.#..#....##..##.###.##.#.##....
...###.######...##..#.####.###..#...#..#..#..#..##.#.#....#....#####.#.##..#.##.#.########..###.##..
.#...#####.#..#..##.##.#.###......#..#..#.###......#...#.#.#######..#...####.#.########...#..##.#.#.
#..#####.#.#.#....##.#..#.......##..#.##.##......#..##..#..#..##.#.###..#.#.#.#..#..#.##.####.#.#..#
####...#.....#.#..#..#.##########..#..#...######.######.#.#.....#....#.###.####.##..#..#.####..###..
.####.###.####...#...####.##..###..#######.###.#....##.###.#..#.#####...##.#..#.....#.####..#..#####
"""
    .lines
    .map{
      $0.map{ $0 == "#" ? 1 : 0 }
    }

  print(image)

  var working = image
  let borderSize = 55
  let borderTopBottom = Array(
    repeating: Array(repeating: 0, count: image[0].count),
    count: borderSize
    )
  let borderLeftRight = Array(repeating: 0, count: borderSize)

  working = borderTopBottom + working + borderTopBottom
  working = working.map{ borderLeftRight + $0 + borderLeftRight }

  func show() {
    working.forEach{
      print($0.map{$0 == 1 ? "#" : "."}.joined())
    }
  }

  show()
  
  func maxx() -> Int { working[0].count }
  func maxy() -> Int { working.count }

  func get(_ x: Int, _ y: Int) -> Int {
    if x < 0 || x >= maxx() { return 0 }
    if y < 0 || y >= maxy() { return 0 }
    return working[y][x]
  }
  
  for step in 1...50 {
    var working2 = working // Just to get the size (it'll all be overwritten below)
    for x in 0..<maxx() {
      for y in 0..<maxy() {
        if x == 6 && y == 4 && step == 1 {
          var a = 2
          a += 2
        }
        let index =
        256 * get(x-1,y-1) + 128 * get(x, y-1) + 64 * get(x+1, y-1) +
        32  * get(x-1,y  ) +  16 * get(x, y  ) +  8 * get(x+1, y  ) +
        4   * get(x-1,y+1) +   2 * get(x, y+1) +  1 * get(x+1, y+1)

        let test =
        [256 * get(x-1,y-1)] + [128 * get(x, y-1)] + [64 * get(x+1, y-1)] +
        [32  * get(x-1,y  )] + [ 16 * get(x, y  )] + [ 8 * get(x+1, y  )] +
        [4   * get(x-1,y+1)] + [  2 * get(x, y+1)] + [ 1 * get(x+1, y+1)]
        
        let newValue = algorithm[index]

        working2[y][x] = algorithm[index]
      }
    }
    working = working2
    // Nonzero edge values can cause trouble so whenever the general infinite background is 0
    // (noe that this relies on the border being broad enough that [2][2] is never corrupted by the working image and is part of the infinite area
    if working[2][2] == 0 {
      // make all the edges zero too
      zeroEdge()
    }
    print("=================================")
    show()
  }
  
  func zeroEdge() {
    for x in 0..<maxx() {
      working[0][x] = 0
      working[maxy()-1][x] = 0
    }
    for y in 0..<maxy() {
      working[y][0] = 0
      working[y][maxx()-1] = 0
    }
  }

  zeroEdge()
  print("=================================")
  show()
  let lit = working.reduce(0){ $0+$1.reduce(0, +) }
  print("Lit Count = \(lit)")
    
}

